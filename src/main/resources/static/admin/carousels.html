<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>众评优选 | 轮播图管理</title>
<link href="../libs/bootstrap/5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="../libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../libs/admin-lte/3.2.0/dist/css/adminlte.min.css" rel="stylesheet"/>
<link href="css/admin.css" rel="stylesheet"/>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
<ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
<ul class="navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="/index.html" role="button">
<i class="fas fa-home mr-1"></i> 返回首页
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="logoutButton" role="button">
<i class="fas fa-sign-out-alt"></i> 退出登录
</a>
</li>
</ul>
</nav>
<aside class="main-sidebar sidebar-dark-primary elevation-4">
<a class="brand-link" href="index.html"><img alt="Logo" class="brand-image img-circle elevation-3" src="img/AdminLTELogo.png" style="opacity: .8"/><span class="brand-text font-weight-light">众评优选后台</span></a>
<div class="sidebar">
<div class="user-panel mt-3 pb-3 mb-3 d-flex"><div class="info"><a class="d-block" href="#" id="sidebar-username">...</a></div></div>
<nav class="mt-2">
<ul class="nav nav-pills nav-sidebar flex-column" data-accordion="false" data-widget="treeview" role="menu">
<li class="nav-item">
<a class="nav-link" href="index.html">
<i class="nav-icon fas fa-tachometer-alt"></i>
<p>仪表盘</p>
</a>
</li>
<li class="nav-header">内容管理</li>
<li class="nav-item">
<a class="nav-link active" href="carousels.html">
<i class="nav-icon fas fa-images"></i>
<p>轮播图管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="products.html">
<i class="nav-icon fas fa-box"></i>
<p>商品管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="reviews.html">
<i class="nav-icon fas fa-comments"></i>
<p>评价管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="users.html">
<i class="nav-icon fas fa-users"></i>
<p>用户管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="categories.html">
<i class="nav-icon fas fa-tags"></i>
<p>分类管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="merchants.html">
<i class="nav-icon fas fa-store"></i>
<p>商家管理</p>
</a>
</li>
</ul>
</nav>
</div>
</aside>
<div class="content-wrapper">
<section class="content-header">
<div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1>轮播图管理</h1></div></div></div>
</section>
<section class="content">
<div class="container-fluid">
<div class="card">
<div class="card-header">
<h3 class="card-title">轮播图列表</h3>
<div class="card-tools">
<div class="input-group input-group-sm" style="width: 300px;">
<input class="form-control float-right" id="carouselSearchInput" placeholder="搜索轮播图标题或链接" type="text"/>
<div class="input-group-append">
<button class="btn btn-default" id="carouselSearchButton" type="button">
<i class="fas fa-search"></i>
</button>
</div>
</div>
</div>
</div>
<div class="card-body">
<button class="btn btn-primary btn-sm mb-3" id="createCarouselBtn"><i class="fas fa-plus"></i> 添加新轮播图</button>
<table class="table table-bordered table-hover" id="carouselsTable">
<thead><tr><th>ID</th><th>图片预览</th><th>目标URL</th><th>显示顺序</th><th>操作</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<div class="modal fade" id="carouselModal" role="dialog" tabindex="-1">
<div class="modal-dialog" role="document">
<div class="modal-content">
<form id="carouselForm">
<div class="modal-header"><h5 class="modal-title" id="modalTitle">添加轮播图</h5><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<input id="carouselId" type="hidden"/>
<div class="form-group">
<label for="carouselImage">轮播图片</label>
<div class="input-group">
<div class="custom-file">
<input accept="image/*" class="custom-file-input" id="carouselImage" name="image" type="file"/>
<label class="custom-file-label" for="carouselImage">选择图片</label>
</div>
</div>
<small class="form-text text-muted">支持JPG、PNG格式，建议尺寸1200x400像素</small>
</div>
<div class="form-group">
<label>图片预览</label>
<div class="mt-3 d-none" id="imagePreviewContainer">
<div class="mt-2">
<img alt="轮播图预览" class="img-fluid img-thumbnail" id="imagePreview" src="" style="max-height: 150px;"/>
</div>
</div>
</div>
<div class="form-group">
<label for="pagePath">目标页面</label>
<select class="form-control" id="pagePath">
<option value="">请选择目标页面</option>
<option value="/index.html">首页</option>
<option value="/login.html">登录页</option>
<option value="/merchants.html">商家列表</option>
<option value="/products.html">商品列表</option>
<option value="/reviews.html">评价列表</option>
<option value="/users.html">用户列表</option>
<option value="/product/detail.html">商品详情页</option>
<option value="/product/list.html">商品列表页</option>
<option value="/user/favorites.html">用户收藏</option>
<option value="/user/profile.html">用户资料</option>
</select>
</div>
<div class="form-group">
<label for="urlParams">URL参数（如: id=7 或 id=7&amp;type=1）</label>
<input class="form-control" id="urlParams" placeholder="请输入URL参数" type="text"/>
<small class="form-text text-muted">无需添加问号(?)，系统会自动添加</small>
</div>
<div class="form-group"><label for="displayOrder">显示顺序</label><input class="form-control" id="displayOrder" required="" type="number" value="0"/></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" type="button">关闭</button><button class="btn btn-primary" type="submit">保存</button></div>
</form>
</div>
</div>
</div>
<script src="../libs/jquery/3.7.1/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="../libs/datatables.net-bs5/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="../libs/admin-lte/3.2.0/dist/js/adminlte.min.js"></script>
<script>

    const token = localStorage.getItem('jwtToken');
    if (!token) {

        window.location.href = 'login.html';
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {

        window.location.href = 'login.html';
    }
    

    if (!user.roles || !user.roles.includes('ROLE_ADMIN')) {

        alert('您无权访问管理后台！只有管理员可以进入。');

        setTimeout(() => {
            window.location.href = '/index.html';
        }, 500);
    }
    

    if (user && user.username) {
        document.getElementById('sidebar-username').textContent = user.username;
    }
    
    document.getElementById('logoutButton').addEventListener('click', () => { 
        localStorage.clear(); 
        window.location.href = 'login.html'; 
    });

    const API_URL = 'http://localhost:8080/api/admin/carousels';
    const HEADERS = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };


    $('#carouselImage').on('change', function() {
        const file = this.files[0];
        if (file) {

            $('.custom-file-label').text(file.name);
            

            const reader = new FileReader();
            reader.onload = function(e) {
                $('#imagePreview').attr('src', e.target.result);
                $('#imagePreviewContainer').removeClass('d-none');
            }
            reader.readAsDataURL(file);
        } else {
            $('.custom-file-label').text('选择图片');
            $('#imagePreviewContainer').addClass('d-none');
        }
    });


    let carouselSearchTerm = '';


    document.getElementById('carouselSearchButton').addEventListener('click', () => {
        carouselSearchTerm = document.getElementById('carouselSearchInput').value.trim();
        table.ajax.reload();
    });


    document.getElementById('carouselSearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            carouselSearchTerm = e.target.value.trim();
            table.ajax.reload();
        }
    });
    

    const table = $('#carouselsTable').DataTable({
        "processing": true,
        "serverSide": false,
        "ajax": {
            "url": API_URL,
            "headers": HEADERS,
            "data": function(d) {

                if (carouselSearchTerm) {
                    d.keyword = carouselSearchTerm;
                }
            },
            "dataSrc": function(data) {

                return Array.isArray(data) ? data : [];
            },
            "error": function(xhr, status, error) {
                console.error("AJAX错误:", status, error);
                alert("获取轮播图数据失败，请稍后再试。");
            }
        },
        "columns": [
            { "data": "id" },
            { 
                "data": "imageUrl", 
                "render": url => url ? `<img src="${url}" width="150" height="80" class="img-thumbnail rounded" alt="preview">` : '<span class="text-muted">无图片</span>'
            },
            { 
                "data": "targetUrl", 
                "defaultContent": "-",
                "render": url => url ? `<a href="${url}" target="_blank">${url}</a>` : "-"
            },
            { "data": "displayOrder", "defaultContent": 0 },
            { 
                "data": null, 
                "defaultContent": '<button class="btn btn-info btn-sm edit-btn mr-2"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i></button>', 
                "orderable": false,
                "className": "text-center"
            }
        ]
    });

    $('#createCarouselBtn').on('click', () => {
        $('#carouselForm')[0].reset();
        $('#carouselId').val('');
        $('#pagePath').val('');
        $('#urlParams').val('');
        $('#displayOrder').val('0');
        $('#carouselImage').val('');
        $('.custom-file-label').text('选择图片');
        $('#imagePreviewContainer').addClass('d-none');
        $('#modalTitle').text('添加新轮播图');
        $('#carouselModal').modal('show');
    });


    $('#carouselsTable tbody').on('click', '.edit-btn', function () {
        const data = table.row($(this).parents('tr')).data();
        $('#modalTitle').text('编辑轮播图');
        $('#carouselId').val(data.id);
        $('#displayOrder').val(data.displayOrder);
        

        if (data.targetUrl) {
            const urlParts = data.targetUrl.split('?');
            const pagePath = urlParts[0];
            const urlParams = urlParts[1] || '';
            
            $('#pagePath').val(pagePath);
            $('#urlParams').val(urlParams);
        } else {
            $('#pagePath').val('');
            $('#urlParams').val('');
        }
        

        $('#existingImageUrl').remove();
        

        if (data.imageUrl) {
            console.log('设置轮播图预览URL:', data.imageUrl);
            $('#imagePreview').attr('src', data.imageUrl);
            $('#imagePreviewContainer').removeClass('d-none');
            

            $('<input>').attr({
                type: 'hidden',
                id: 'existingImageUrl',
                name: 'existingImageUrl',
                value: data.imageUrl
            }).appendTo('#carouselForm');
        } else {
            console.log('没有图片URL，隐藏预览');
            $('#imagePreviewContainer').addClass('d-none');
        }
        

        $('#carouselImage').val('');
        $('.custom-file-label').text('选择图片');
        $('#carouselModal').modal('show');
    });

    $('#carouselForm').on('submit', async function(e) {
        e.preventDefault();
        const id = $('#carouselId').val();
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/${id}` : API_URL;
        

        const pagePath = $('#pagePath').val();
        const urlParams = $('#urlParams').val();
        const displayOrder = $('#displayOrder').val();
        const imageFile = $('#carouselImage')[0].files[0];
        
        if (!imageFile && !id) {
            alert('请选择轮播图片');
            return;
        }
        
        if (!displayOrder) {
            alert('请输入显示顺序');
            return;
        }
        

        let targetUrl = pagePath;
        if (urlParams.trim()) {
            targetUrl += '?' + urlParams.trim();
        }
        
        const formData = new FormData();
        if (imageFile) {
            formData.append('imageFile', imageFile);
        } else if (id) {

            const existingImageUrl = $('#existingImageUrl').val();
            if (existingImageUrl) {
                formData.append('existingImageUrl', existingImageUrl);
            }
        }
        formData.append('targetUrl', targetUrl);
        formData.append('displayOrder', displayOrder);

        const response = await fetch(url, { 
            method, 
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData 
        });
        if(response.ok) {
            $('#carouselModal').modal('hide');
            table.ajax.reload();
        } else {
            alert('操作失败');
        }
    });

    $('#carouselsTable tbody').on('click', '.delete-btn', async function () {
        const data = table.row($(this).parents('tr')).data();
        if (confirm(`确定删除此轮播图吗?`)) {
            const response = await fetch(`${API_URL}/${data.id}`, { method: 'DELETE', headers: HEADERS });
            if (response.ok) table.ajax.reload();
            else alert('删除失败');
        }
    });
</script>
</body>
</html>