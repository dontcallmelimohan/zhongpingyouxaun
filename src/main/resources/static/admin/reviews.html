<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>众评优选 | 评价管理</title>
<link href="../libs/bootstrap/5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="../libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../libs/admin-lte/3.2.0/dist/css/adminlte.min.css" rel="stylesheet"/>
<link href="css/admin.css" rel="stylesheet"/>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
<ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
<ul class="navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="/index.html" role="button">
<i class="fas fa-home mr-1"></i> 返回首页
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="logoutButton" role="button">
<i class="fas fa-sign-out-alt"></i> 退出登录
</a>
</li>
</ul>
</nav>
<aside class="main-sidebar sidebar-dark-primary elevation-4">
<a class="brand-link" href="index.html"><img alt="Logo" class="brand-image img-circle elevation-3" src="img/AdminLTELogo.png" style="opacity: .8"/><span class="brand-text font-weight-light">众评优选后台</span></a>
<div class="sidebar">
<div class="user-panel mt-3 pb-3 mb-3 d-flex"><div class="info"><a class="d-block" href="#" id="sidebar-username">...</a></div></div>
<nav class="mt-2">
<ul class="nav nav-pills nav-sidebar flex-column" data-accordion="false" data-widget="treeview" role="menu">
<li class="nav-item">
<a class="nav-link" href="index.html">
<i class="nav-icon fas fa-tachometer-alt"></i>
<p>仪表盘</p>
</a>
</li>
<li class="nav-header">内容管理</li>
<li class="nav-item">
<a class="nav-link" href="carousels.html">
<i class="nav-icon fas fa-images"></i>
<p>轮播图管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="products.html">
<i class="nav-icon fas fa-box"></i>
<p>商品管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="reviews.html">
<i class="nav-icon fas fa-comments"></i>
<p>评价管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="users.html">
<i class="nav-icon fas fa-users"></i>
<p>用户管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="categories.html">
<i class="nav-icon fas fa-tags"></i>
<p>分类管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="merchants.html">
<i class="nav-icon fas fa-store"></i>
<p>商家管理</p>
</a>
</li>
</ul>
</nav>
</div>
</aside>
<div class="content-wrapper">
<section class="content-header">
<div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1>评价管理</h1></div></div></div>
</section>
<section class="content">
<div class="container-fluid">
<div class="card">
<div class="card-header">
<h3 class="card-title">所有评价列表</h3>
<div class="card-tools">
<div class="input-group input-group-sm" style="width: 300px;">
<input class="form-control float-right" id="reviewSearchInput" placeholder="搜索商品名称或评价内容" type="text"/>
<div class="input-group-append">
<button class="btn btn-default" id="reviewSearchButton" type="button">
<i class="fas fa-search"></i>
</button>
</div>
</div>
</div>
</div>
<div class="card-body">
<table class="table table-bordered table-striped" id="reviewsTable">
<thead><tr><th>ID</th><th>标题</th><th>评分</th><th>用户</th><th>商品ID</th><th>发布时间</th><th>操作</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<script src="../libs/jquery/3.7.1/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="../libs/datatables.net-bs5/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="../libs/admin-lte/3.2.0/dist/js/adminlte.min.js"></script>
<script>
    const token = localStorage.getItem('jwtToken');
    if (!token) {
        window.location.href = 'login.html';
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        window.location.href = 'login.html';
    }

    if (!user.roles || !user.roles.includes('ROLE_ADMIN')) {
        alert('您无权访问管理后台！只有管理员可以进入。');
        setTimeout(() => {
            window.location.href = '/index.html';
        }, 500);
    }

    if (user && user.username) {
        document.getElementById('sidebar-username').textContent = user.username;
    }
    
    document.getElementById('logoutButton').addEventListener('click', () => { 
        localStorage.clear(); 
        window.location.href = 'login.html'; 
    });

    const API_URL = 'http://localhost:8080/api/admin/reviews';
    const HEADERS = { 'Authorization': `Bearer ${token}` };

    let reviewSearchTerm = '';

    document.getElementById('reviewSearchButton').addEventListener('click', () => {
        reviewSearchTerm = document.getElementById('reviewSearchInput').value.trim();
        table.ajax.reload();
    });

    document.getElementById('reviewSearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            reviewSearchTerm = e.target.value.trim();
            table.ajax.reload();
        }
    });

    const table = $('#reviewsTable').DataTable({
        "serverSide": true,
        "processing": true,
        "ajax": {
            "url": "http://localhost:8080/api/admin/reviews",
            "headers": HEADERS,
            "data": function(d) {
                    if (reviewSearchTerm) {
                        d.search = reviewSearchTerm;
                    }
                },
            "dataFilter": (data) => {
                try {
                    let json = JSON.parse(data);
                    json.recordsTotal = json.totalElements || 0;
                    json.recordsFiltered = json.totalElements || 0;
                    json.data = json.content || [];
                    return JSON.stringify(json);
                } catch (e) {
                    console.error("数据解析错误:", e);
                    return JSON.stringify({ recordsTotal: 0, recordsFiltered: 0, data: [] });
                }
            },
            "error": function(xhr, status, error) {
                console.error("AJAX错误:", status, error);
                alert("获取评价数据失败，请稍后再试。");
            }
        },
        "columns": [
            { "data": "id" },
            { "data": "title", "defaultContent": "-" },
            { 
                "data": "rating", 
                "defaultContent": 0,
                "render": data => {
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        stars += i <= data ? '<i class="fas fa-star text-warning"></i>' : '<i class="far fa-star text-gray-300"></i>';
                    }
                    return stars;
                }
            },
            { "data": "username", "defaultContent": "-" },
            { "data": "productId", "defaultContent": "-" },
            { "data": "createdAt", "render": data => data ? new Date(data).toLocaleString() : "-" },
            { 
                "data": null, 
                "defaultContent": '<button class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i></button>', 
                "orderable": false,
                "className": "text-center"
            }
        ]
    });

    $('#reviewsTable tbody').on('click', '.delete-btn', async function () {
        const data = table.row($(this).parents('tr')).data();
        if (confirm(`确定删除标题为 "${data.title}" 的评价吗?`)) {
            const response = await fetch(`${API_URL}/${data.id}`, { method: 'DELETE', headers: HEADERS });
            if (response.ok) {
                alert('评价删除成功');
                table.ajax.reload();
            } else {
                alert('删除失败');
            }
        }
    });
</script>
</body>
</html>