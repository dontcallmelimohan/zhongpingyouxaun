<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>众评优选 | 分类管理</title>
<link href="../libs/bootstrap/5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="../libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../libs/datatables.net-bs5/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
<link href="../libs/datatables.net-responsive-bs5/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet"/>
<link href="../libs/admin-lte/3.2.0/dist/css/adminlte.min.css" rel="stylesheet"/>
<link href="css/admin.css" rel="stylesheet"/>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
<ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li></ul>
<ul class="navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="/index.html" role="button">
<i class="fas fa-home mr-1"></i> 返回首页
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="logoutButton" role="button">
<i class="fas fa-sign-out-alt"></i> 退出登录
</a>
</li>
</ul>
</nav>
<aside class="main-sidebar sidebar-dark-primary elevation-4">
<a class="brand-link" href="index.html"><img alt="Logo" class="brand-image img-circle elevation-3" src="img/AdminLTELogo.png" style="opacity: .8"/><span class="brand-text font-weight-light">众评优选后台</span></a>
<div class="sidebar">
<div class="user-panel mt-3 pb-3 mb-3 d-flex"><div class="info"><a class="d-block" href="#" id="sidebar-username">...</a></div></div>
<nav class="mt-2">
<ul class="nav nav-pills nav-sidebar flex-column" data-accordion="false" data-widget="treeview" role="menu">
<li class="nav-item">
<a class="nav-link" href="index.html">
<i class="nav-icon fas fa-tachometer-alt"></i>
<p>仪表盘</p>
</a>
</li>
<li class="nav-header">内容管理</li>
<li class="nav-item">
<a class="nav-link" href="carousels.html">
<i class="nav-icon fas fa-images"></i>
<p>轮播图管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="products.html">
<i class="nav-icon fas fa-box"></i>
<p>商品管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="reviews.html">
<i class="nav-icon fas fa-comments"></i>
<p>评价管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="users.html">
<i class="nav-icon fas fa-users"></i>
<p>用户管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="categories.html">
<i class="nav-icon fas fa-tags"></i>
<p>分类管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="merchants.html">
<i class="nav-icon fas fa-store"></i>
<p>商家管理</p>
</a>
</li>
</ul>
</nav>
</div>
</aside>
<div class="content-wrapper">
<section class="content-header">
<div class="container-fluid"><div class="row mb-2"><div class="col-sm-6"><h1>分类管理</h1></div></div></div>
</section>
<section class="content">
<div class="container-fluid">
<div class="card">
<div class="card-header">
<h3 class="card-title">分类列表</h3>
<div class="card-tools">
<div class="input-group input-group-sm" style="width: 300px;">
<input class="form-control float-right" id="categorySearchInput" placeholder="搜索分类名称" type="text"/>
<div class="input-group-append">
<button class="btn btn-default" id="categorySearchButton" type="button">
<i class="fas fa-search"></i>
</button>
</div>
</div>
</div>
</div>
<div class="card-body">
<button class="btn btn-primary btn-sm mb-3" id="createCategoryBtn"><i class="fas fa-plus"></i> 创建新分类</button>
<table class="table table-bordered table-striped" id="categoriesTable">
<thead><tr><th>ID</th><th>名称</th><th>操作</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<div class="modal fade" id="categoryModal" role="dialog" tabindex="-1">
<div class="modal-dialog" role="document">
<div class="modal-content">
<form id="categoryForm">
<div class="modal-header"><h5 class="modal-title" id="modalTitle">创建分类</h5><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div>
<div class="modal-body">
<input id="categoryId" type="hidden"/>
<div class="form-group"><label for="name">分类名称</label><input class="form-control" id="name" required="" type="text"/></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal" type="button">关闭</button><button class="btn btn-primary" type="submit">保存</button></div>
</form>
</div>
</div>
</div>
<script src="../libs/jquery/3.7.1/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="../libs/datatables.net-bs5/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="../libs/datatables.net-responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="../libs/datatables.net-responsive-bs5/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="../libs/admin-lte/3.2.0/dist/js/adminlte.min.js"></script>
<script>

    const token = localStorage.getItem('jwtToken');
    if (!token) {

        window.location.href = 'login.html';
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {

        window.location.href = 'login.html';
    }
    

    if (!user.roles || !user.roles.includes('ROLE_ADMIN')) {

        window.location.href = 'index.html';
    }
    

    document.getElementById('sidebar-username').textContent = user.username;
    

    const API_URL = 'http://localhost:8080/api/categories';
    const HEADERS = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
    

    let categories = [];
    let categorySearchTerm = '';
    let categoriesTable;
    

    function handleAuthError(response) {
        if (response.status === 401 || response.status === 403) {

            localStorage.removeItem('jwtToken');
            localStorage.removeItem('user');

            window.location.href = 'login.html';
            return true;
        }
        return false;
    }
    

    async function loadCategoryData() {
        try {
            const response = await fetch(API_URL, { headers: HEADERS });
            

            if (handleAuthError(response)) {
                return;
            }
            
            if (response.ok) {
                categories = await response.json();
                console.log('加载的分类数据:', categories);
                renderCategoriesTable();
            } else {
                console.error('获取分类数据失败:', response.status, response.statusText);
                showNotification('error', '获取分类数据失败');
            }
        } catch (error) {
            console.error('加载分类数据失败:', error);
            showNotification('error', '网络错误，请稍后重试');
        }
    }
    

    function renderCategoriesTable() {
        const tbody = document.querySelector('#categoriesTable tbody');
        tbody.innerHTML = '';
        

        let filteredCategories = categories;
        if (categorySearchTerm) {
            filteredCategories = categories.filter(category => 
                category.name.toLowerCase().includes(categorySearchTerm.toLowerCase())
            );
        }
        

        tbody.innerHTML = '';
        

        if (!$.fn.DataTable.isDataTable('#categoriesTable')) {
            categoriesTable = $('#categoriesTable').DataTable({
                responsive: true,
                dom: 'lrtip',
                data: filteredCategories,
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    {
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-sm btn-primary edit-btn" onclick="handleEdit(${row.id}, '${row.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-danger delete-btn" onclick="handleDelete(${row.id}, '${row.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: '../libs/zh.json'
                },

            });
        } else {

            categoriesTable.clear();
            categoriesTable.rows.add(filteredCategories);
            categoriesTable.draw();

        }
    }
    

    function handleEdit(id, name) {
        $('#categoryForm')[0].reset();
        $('#modalTitle').text('编辑分类');
        $('#categoryId').val(id);
        $('#name').val(name);
        

        const modalElement = document.getElementById('categoryModal');
        const categoryModal = new bootstrap.Modal(modalElement);
        categoryModal.show();
    }
    

    async function handleDelete(id, name) {
        if (confirm(`确定删除分类 "${name}"?`)) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers: HEADERS
                });
                

                if (handleAuthError(response)) {
                    return;
                }
                
                if (response.ok) {
                    loadCategoryData();
                    showNotification('success', '分类删除成功！');
                } else {
                    const errorData = await response.json();
                    showNotification('error', errorData.message || '删除失败');
                }
            } catch (error) {
                console.error('删除失败:', error);
                showNotification('error', '网络错误，请稍后重试');
            }
        }
    }
    

    function showNotification(type, message) {

        const notification = document.createElement('div');
        notification.className = `position-fixed top-5 right-5 p-3 rounded shadow-lg z-50 transition-all duration-300 ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
        notification.innerText = message;
        

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    

    document.getElementById('categorySearchButton').addEventListener('click', () => {
        categorySearchTerm = document.getElementById('categorySearchInput').value.trim();
        renderCategoriesTable();
    });
    

    document.getElementById('categorySearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            categorySearchTerm = e.target.value.trim();
            renderCategoriesTable();
        }
    });
    

    document.getElementById('createCategoryBtn').addEventListener('click', () => {
        $('#categoryForm')[0].reset();
        $('#categoryId').val('');
        $('#modalTitle').text('创建新分类');
        

        const modalElement = document.getElementById('categoryModal');
        const categoryModal = new bootstrap.Modal(modalElement);
        categoryModal.show();
    });
    

    $('#categoryForm').on('submit', async function(e) {
        e.preventDefault();
        const id = $('#categoryId').val();
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/${id}` : API_URL;
        

        const name = $('#name').val();
        if (!name) {
            showNotification('error', '请填写分类名称');
            return;
        }
        
        try {
            const response = await fetch(url, { 
                method, 
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: `name=${encodeURIComponent(name)}`
            });
            

            if (handleAuthError(response)) {
                return;
            }
            
            if (response.ok) {

                const categoryModal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
                categoryModal.hide();
                
                loadCategoryData();
                showNotification('success', id ? '分类更新成功！' : '分类创建成功！');
            } else {
                const errorData = await response.json();
                showNotification('error', errorData.message || '操作失败');
            }
        } catch (error) {
            console.error('操作失败:', error);
            showNotification('error', '网络错误，请稍后重试');
        }
    });
    

    document.getElementById('logoutButton').addEventListener('click', function(e) {
        e.preventDefault();

        localStorage.removeItem('jwtToken');
        localStorage.removeItem('user');

        window.location.href = 'login.html';
    });
    


    document.addEventListener('DOMContentLoaded', function() {
        loadCategoryData();
    });
</script>
</body>
</html>