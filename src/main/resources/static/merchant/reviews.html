<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>评价管理 - 众评优选商家后台</title>
<link href="../libs/bootstrap/5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="../libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="../libs/datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="../libs/datatables.net-bs5/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
<link href="../libs/admin-lte/3.2.0/dist/css/adminlte.min.css" rel="stylesheet"/>
<script src="js/merchant-auth.js"></script>
<style>
        .content-wrapper {
            background-color: #f8f9fa;
        }
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
        }
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .sidebar-dark-primary {
            background-color: #343a40;
        }
        .review-card {
            border-radius: 8px;
            overflow: hidden;
        }
        .review-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .star-rating {
            color: #ffc107;
        }
        .response-section {
            background-color: #e9f7fe;
            border-left: 4px solid #17a2b8;
        }
        .response-form {
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 8px;
        }
        .btn-primary {
            background-color: #165DFF;
            border-color: #165DFF;
        }
        .btn-primary:hover {
            background-color: #0E42C0;
            border-color: #0E42C0;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
<ul class="navbar-nav">
<li class="nav-item">
<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fa fa-bars"></i></a>
</li>
</ul>
<ul class="navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" href="/index.html" role="button">
<i class="fa fa-home mr-1"></i> 返回首页
                    </a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="logoutButton">
<i class="fa fa-sign-out mr-1"></i> 退出登录
                    </a>
</li>
<li class="nav-item dropdown user-menu">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">
<i class="fa fa-user-circle mr-2" style="font-size: 20px;"></i>
<span class="d-none d-md-inline" id="merchantName">商家名称</span>
</a>
<div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
<a class="dropdown-item" href="profile.html">
<i class="fa fa-user mr-2"></i> 个人资料
                        </a>
<a class="dropdown-item" href="#">
<i class="fa fa-cog mr-2"></i> 设置
                        </a>
</div>
</li>
</ul>
</nav>
<aside class="main-sidebar sidebar-dark-primary elevation-4">
<a class="brand-link" href="dashboard.html">
<i class="fa fa-store mr-2" style="font-size: 24px;"></i>
<span class="brand-text font-weight-light">众评优选商家后台</span>
</a>
<div class="sidebar">
<div class="user-panel mt-3 pb-3 mb-3 d-flex">
<div class="image">
<i class="fa fa-user-circle text-white" style="font-size: 32px;"></i>
</div>
<div class="info">
<a class="d-block" href="profile.html" id="sidebar-merchant-name">商家名称</a>
</div>
</div>
<nav class="mt-2">
<ul class="nav nav-pills nav-sidebar flex-column" data-accordion="false" data-widget="treeview" role="menu">
<li class="nav-item">
<a class="nav-link" href="dashboard.html">
<i class="nav-icon fa fa-dashboard"></i>
<p>仪表盘</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="products.html">
<i class="nav-icon fa fa-shopping-bag"></i>
<p>商品管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="reviews.html">
<i class="nav-icon fa fa-comment"></i>
<p>评价管理</p>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="profile.html">
<i class="nav-icon fa fa-user"></i>
<p>商家设置</p>
</a>
</li>
</ul>
</nav>
</div>
</aside>
<div class="content-wrapper">
<div class="content-header">
<div class="container-fluid">
<div class="row mb-2">
<div class="col-sm-6">
<h1 class="m-0">评价管理</h1>
</div>
</div>
</div>
</div>
<div class="content">
<div class="container-fluid">
<div class="card">
<div class="card-header">
<h3 class="card-title">筛选评价</h3>
</div>
<div class="card-body">
<div class="row align-items-end">
<div class="col-md-4">
<div class="input-group">
<input class="form-control" id="reviewSearchInput" placeholder="搜索商品名称或评价内容" type="text"/>
<div class="input-group-append">
<button class="btn btn-primary" id="reviewSearchButton" type="button">
<i class="fa fa-search"></i> 搜索
                                    </button>
</div>
</div>
</div>
<div class="col-md-4">
<select class="form-control" id="ratingFilter">
<option value="">全部评分</option>
<option value="5">5星</option>
<option value="4">4星</option>
<option value="3">3星</option>
<option value="2">2星</option>
<option value="1">1星</option>
</select>
</div>
<div class="col-md-4">
<select class="form-control" id="responseFilter">
<option value="">全部状态</option>
<option value="PENDING">待回复</option>
<option value="REPLIED">已回复</option>
</select>
</div>
</div>
</div>
</div>

<div class="card mt-4">
<div class="card-header">
<h3 class="card-title">评价列表</h3>
<div class="card-tools">
<div class="btn-group"></div>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover text-nowrap" id="reviewsTable">
<thead>
<tr>
<th>ID</th>
<th>商品名称</th>
<th>用户</th>
<th>评分</th>
<th>评价内容</th>
<th>评价时间</th>
<th>回复状态</th>
<th>操作</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<div aria-labelledby="replyModalLabel" aria-modal="true" class="modal fade" id="replyModal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="replyModalLabel">回复评价</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
</button>
</div>
<div class="modal-body">
<input id="reviewIdToReply" type="hidden"/>
<div class="review-card mb-4">
<div class="review-header p-3">
<div class="row">
<div class="col-md-6">
<strong id="replyProductName">商品名称</strong>
</div>
<div class="col-md-6 text-right">
<span class="star-rating" id="replyRating">
<i class="fa fa-star"></i>
<i class="fa fa-star"></i>
<i class="fa fa-star"></i>
<i class="fa fa-star"></i>
<i class="fa fa-star"></i>
</span>
</div>
</div>
<div class="row mt-2">
<div class="col-md-6">
<small class="text-muted">用户：<span id="replyUserName">用户名</span></small>
</div>
<div class="col-md-6 text-right">
<small class="text-muted"><span id="replyDate">评价时间</span></small>
</div>
</div>
</div>
<div class="p-4">
<p id="replyContent">评价内容将显示在这里...</p>
</div>
<div class="p-4 response-section d-none" id="existingResponseContainer">
<div class="mb-2">
<strong>商家回复：</strong>
</div>
<p id="existingResponse">现有回复内容将显示在这里...</p>
<small class="text-muted d-block mt-2">回复时间：<span id="existingResponseDate">回复时间</span></small>
</div>
</div>
<div class="response-form p-4" id="replyFormContainer">
<div class="form-group">
<label for="replyText">回复内容：</label>
<textarea class="form-control" id="replyText" placeholder="请输入您的回复内容..." required="" rows="4"></textarea>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
<button class="btn btn-primary" id="submitReplyButton" type="button">提交回复</button>
</div>
</div>
</div>
</div>

</div>
<script src="../libs/jquery/3.7.1/dist/jquery.min.js"></script>
<script src="../libs/bootstrap/5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../libs/datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="../libs/datatables.net-bs5/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="../libs/admin-lte/3.2.0/dist/js/adminlte.min.js"></script>
<script>
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }
        
        const merchant = JSON.parse(localStorage.getItem('user'));
        if (!merchant) {
            window.location.href = 'login.html';
        }

        if (merchant && merchant.name) {
            document.getElementById('merchantName').textContent = merchant.name;
            document.getElementById('sidebar-merchant-name').textContent = merchant.name;
        }

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });

        const HEADERS = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        let searchTerm = '';
        let selectedRating = '';
        let selectedResponseStatus = '';
        let allReviews = [];

        async function loadReviewData() {
            try {
                const response = await fetch('http://localhost:8080/api/reviews/merchant', {
                    headers: HEADERS
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allReviews = data.content || [];
                    filterAndRenderReviews();
                } else {
                    console.error('获取评价数据失败:', response.status);
                    showNotification('error', '获取评价数据失败');
                }
            } catch (error) {
                console.error('获取评价数据失败:', error);
                showNotification('error', '网络错误，请稍后重试');
            }
        }

        function filterAndRenderReviews() {
            let filteredReviews = [...allReviews];

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredReviews = filteredReviews.filter(review => {
                    const contentMatch = review.content && review.content.toLowerCase().includes(term);
                    const usernameMatch = review.username && review.username.toLowerCase().includes(term);
                    const productIdMatch = review.productId && review.productId.toString().includes(term);
                    
                    return contentMatch || usernameMatch || productIdMatch;
                });
            }

            if (selectedRating) {
                filteredReviews = filteredReviews.filter(review => 
                    review.rating == selectedRating
                );
            }

            if (selectedResponseStatus) {
                filteredReviews = filteredReviews.filter(review => 
                    review.responseStatus === selectedResponseStatus
                );
            }

            reviewsTable.clear().rows.add(filteredReviews).draw();
        }

        let reviewsTable;
        function initReviewsTable() {
            reviewsTable = $('#reviewsTable').DataTable({
                "processing": false,
                "serverSide": false,
                "searching": false,
                "data": [],
                "columns": [
                    { "data": "id" },
                    { 
                        "data": "productId",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                if (data) {
                                    const spanId = 'product-name-' + row.id;
                                    setTimeout(() => {
                                        loadProductName(data, spanId);
                                    }, 0);
                                    return '<span id="' + spanId + '">加载中...</span>';
                                } else {
                                    return '未知商品';
                                }
                            }
                            return data ? '商品ID: ' + data : '未知商品';
                        }
                    },
                    { 
                        "data": "username",
                        "render": function(data, type, row) {
                            return data || '匿名用户';
                        }
                    },
                    { 
                        "data": "rating",
                        "render": function(data, type, row) {
                            return renderStarRating(data);
                        }
                    },
                    { 
                        "data": "content",
                        "render": function(data, type, row) {
                            return data || '暂无评价内容';
                        }
                    },
                    { 
                        "data": "createdAt",
                        "render": function(data, type, row) {
                            return formatDate(data);
                        }
                    },
                    { 
                        "data": "responseStatus",
                        "render": function(data, type, row) {
                            if (data === 'REPLIED') {
                                return '<span class="badge badge-success">已回复</span>';
                            } else {
                                return '<span class="badge badge-warning">待回复</span>';
                            }
                        }
                    },
                    { 
                        "data": null,
                        "render": function(data, type, row) {
                            return `<button class="btn btn-sm btn-primary reply-btn" data-id="${row.id}">回复</button>`;
                        }
                    }
                ],
                "language": {
                    "search": "搜索:",
                    "lengthMenu": "每页显示 _MENU_ 条记录",
                    "info": "显示第 _START_ 至 _END_ 条记录，共 _TOTAL_ 条",
                    "infoEmpty": "没有找到记录",
                    "infoFiltered": "(从 _MAX_ 条记录中过滤)",
                    "zeroRecords": "没有找到匹配的记录",
                    "paginate": {
                        "first": "首页",
                        "last": "末页",
                        "next": "下一页",
                        "previous": "上一页"
                    }
                }
            });

            $('#reviewsTable').on('click', '.reply-btn', function() {
                console.log('回复按钮被点击，reviewId:', $(this).data('id'));
                const rowData = reviewsTable.row($(this).closest('tr')).data();
                console.log('行数据:', rowData);
                loadReviewDetails(rowData);
            });
        }

        async function loadProductName(productId, elementId) {
            try {
                const response = await fetch(`http://localhost:8080/api/products/${productId}`, {
                    headers: HEADERS
                });
                
                if (response.ok) {
                    const product = await response.json();
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = product.name || '未知商品';
                    }
                } else {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = '商品ID: ' + productId;
                    }
                }
            } catch (error) {
                console.error('获取商品名称失败:', error);
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = '商品ID: ' + productId;
                }
            }
        }

        async function loadReviewDetails(rowData) {
            try {
                console.log('开始加载评价详情，行数据:', rowData);

                document.getElementById('reviewIdToReply').value = rowData.id;

                if (rowData.productId) {
                    loadProductName(rowData.productId, 'replyProductName');
                } else {
                    document.getElementById('replyProductName').textContent = '未知商品';
                }
                
                document.getElementById('replyUserName').textContent = rowData.username || '匿名用户';
                document.getElementById('replyRating').innerHTML = renderStarRating(rowData.rating);
                document.getElementById('replyContent').textContent = rowData.content || '暂无评价内容';
                document.getElementById('replyDate').textContent = formatDate(rowData.createdAt);

                const existingResponseContainer = document.getElementById('existingResponseContainer');
                const replyFormContainer = document.getElementById('replyFormContainer');
                const replyText = document.getElementById('replyText');

                if (rowData.responseStatus === 'REPLIED') {
                    existingResponseContainer.classList.remove('d-none');

                    if (rowData.merchantReply && rowData.merchantReply.content) {
                        document.getElementById('existingResponse').textContent = rowData.merchantReply.content;
                        document.getElementById('existingResponseDate').textContent = formatDate(rowData.merchantReply.createdAt);
                    } else {
                        try {
                            const commentResponse = await fetch(`http://localhost:8080/api/comments/review/${rowData.id}`, {
                                method: 'GET',
                                headers: HEADERS
                            });
                            
                            if (commentResponse.ok) {
                                const commentsData = await commentResponse.json();
                                const merchantReply = commentsData.content.find(comment => 
                                    comment.user && comment.user.roles && 
                                    comment.user.roles.some(role => role.name === 'ROLE_MERCHANT')
                                );
                                
                                if (merchantReply) {
                                    document.getElementById('existingResponse').textContent = merchantReply.content;
                                    document.getElementById('existingResponseDate').textContent = formatDate(merchantReply.createdAt);
                                } else {
                                    document.getElementById('existingResponse').textContent = '商家回复内容获取失败';
                                    document.getElementById('existingResponseDate').textContent = '未知时间';
                                }
                            } else {
                                document.getElementById('existingResponse').textContent = '商家回复内容获取失败';
                                document.getElementById('existingResponseDate').textContent = '未知时间';
                            }
                        } catch (error) {
                            console.error('获取商家回复失败:', error);
                            document.getElementById('existingResponse').textContent = '商家回复内容获取失败';
                            document.getElementById('existingResponseDate').textContent = '未知时间';
                        }
                    }

                    replyFormContainer.classList.add('d-none');
                    replyText.value = '';
                } else {
                    existingResponseContainer.classList.add('d-none');
                    replyFormContainer.classList.remove('d-none');
                    replyText.value = '';
                }

                $('#replyModal').modal('show');
                
            } catch (error) {
                console.error('加载评价详情失败:', error);
                showNotification('error', '加载评价详情失败');
            }
        }

        document.getElementById('submitReplyButton').addEventListener('click', async function() {
            const reviewId = document.getElementById('reviewIdToReply').value;
            const replyContent = document.getElementById('replyText').value.trim();
            
            if (!replyContent) {
                showNotification('error', '请输入回复内容');
                return;
            }
            
            try {
                console.log('开始提交回复，评价ID:', reviewId, '回复内容:', replyContent);
                
                const response = await fetch(`http://localhost:8080/api/comments`, {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify({ 
                        content: replyContent,
                        reviewId: parseInt(reviewId)
                    })
                });
                
                console.log('回复提交响应状态:', response.status);
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('回复提交成功，响应数据:', responseData);
                    
                    $('#replyModal').modal('hide');

                    setTimeout(() => {
                        reviewsTable.ajax.reload();
                        console.log('表格数据已刷新');
                        

                        if (window.opener && window.opener.refreshPendingReviewsCount) {
                            console.log('尝试刷新仪表盘标签页的待回复评价数量...');
                            window.opener.refreshPendingReviewsCount();
                        }

                        if (window.parent && window.parent !== window && window.parent.refreshPendingReviewsCount) {
                            console.log('尝试刷新父页面的待回复评价数量...');
                            window.parent.refreshPendingReviewsCount();
                        }

                        showNotification('success', '回复提交成功，请刷新仪表盘查看更新后的待回复评价数量');
                    }, 500);
                    

                } else {
                    const errorData = await response.json();
                    console.error('回复提交失败，错误信息:', errorData);
                    showNotification('error', errorData.message || '回复提交失败');
                }
            } catch (error) {
                console.error('提交回复失败:', error);
                showNotification('error', '网络错误，请稍后重试');
            }
        });

        document.getElementById('reviewSearchButton').addEventListener('click', function() {
            searchTerm = document.getElementById('reviewSearchInput').value.trim();
            console.log('搜索关键词:', searchTerm);
            filterAndRenderReviews();
        });

        document.getElementById('reviewSearchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchTerm = e.target.value.trim();
                console.log('搜索关键词:', searchTerm);
                filterAndRenderReviews();
            }
        });

        document.getElementById('ratingFilter').addEventListener('change', function(e) {
            selectedRating = e.target.value;
            console.log('选择的评分:', selectedRating);
            filterAndRenderReviews();
        });

        document.getElementById('responseFilter').addEventListener('change', function(e) {
            selectedResponseStatus = e.target.value;
            console.log('选择的回复状态:', selectedResponseStatus);
            filterAndRenderReviews();
        });
        


        function renderStarRating(rating) {
            if (!rating) rating = 0;
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fa fa-star"></i>';
                } else {
                    stars += '<i class="fa fa-star-o"></i>';
                }
            }
            return `<span class="star-rating">${stars}</span>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function showNotification(type, message) {
            console.log('通知:', type, message);
        }

          initMerchantPage(function() {
              initReviewsTable();
              loadReviewData();
          });
      </script>
  </div>

</div>
</body>
</html>